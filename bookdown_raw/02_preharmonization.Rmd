---
output:
  github_document:
    html_preview: false
params:
  documented_drops: NA
  params_in_use: NA
---

# Pre-harmonization decision process

```{r echo=FALSE}
documented_drops <- params$documented_drops
params_in_use <- params$params_in_use
```

## Justification

Following the completion of the {dataRetrieval} download process described in the previous chapter, the pipeline contains raw WQP data for each parameter of interest. Before harmonization of each parameter separately, we run through a series of universal "pre-harmonization" steps, which ensure that all data enters its parameter-specific harmonization routine after it's been tidied and formatted appropriately.

```{r echo = FALSE}
step_order_rev <- max(documented_drops$order):min(documented_drops$order)

step_data <- documented_drops %>%
  group_by(step) %>%
  mutate(scaled = scale(n_rows, center = FALSE)) %>%
  ungroup() %>%
  mutate(order = factor(order,
                        levels = step_order_rev),
         rows_label = paste0(short_reason,
                             ":  ",
                             round((n_rows / 1000000), 1),
                             " M rows")) %>%
  filter(step == "pre-harmonization") 
```

## Initial dataset

```{r echo = FALSE}
step_0_rows <- filter(step_data,
                      step == "pre-harmonization",
                      order == 0) %>%
  mutate(mil_row = n_rows / 1000000) %>%
  pull(mil_row) %>%
  round(digits = 2) %>%
  paste0(., " million")
```

At the start of the pre-harmonization process the WQP dataset contains the parameters `r params_in_use` and `r step_0_rows` rows.

```{r echo = FALSE}
step_data %>%
  filter(order == 0) %>%
  ggplot() +
  geom_bar(aes(x = order, y = scaled, fill = order),
           stat = "identity")  +
  geom_text_repel(aes(x = order, y = 0.1, label = rows_label),
                  bg.color = "white", bg.r = 0.15,
                  point.size = NA,
                  xlim = c(-Inf, Inf),
                  ylim =  c(-Inf, Inf),
                  nudge_x = 0.1,
                  hjust = "left") +
  xlab("Step number") +
  ylab(NULL) +
  scale_fill_manual(values = viridis(n = 11, direction = -1)[1]) +
  scale_x_discrete(drop = F) +
  coord_flip() +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "none")
```

<br>

## Missing results

```{r echo = FALSE}
step_2_rows <- filter(step_data,
                      order == 2) %>%
  mutate(mil_row = n_rows / 1000000) %>%
  pull(mil_row) %>%
  round(digits = 2) %>%
  paste0(., " million")

step_2_dropped <- filter(step_data,
                         order == 2) %>%
  mutate(thou_row = number_dropped / 1000) %>%
  pull(thou_row) %>%
  round(digits = 2) %>%
  paste0(., " thousand")
```

Next records that have missing data are dropped from the dataset. Several criteria are used when checking for missing data. If any of the below criteria are met the sample is removed from the dataset:

1.  Both the result column and detection limit column had `NA` data
2.  Result, result unit, activity comment, laboratory comment, and result comment columns are all `NA`
3.  The result comment column contains any user-provided text indicating a missing value, currently including: `analysis lost`, `not analyzed`, `not recorded`, `not collected`, or `no measurement taken`

This step removes`r step_2_dropped` rows of data, resulting in a final count of `r step_2_rows`.

```{r echo = FALSE}
step_data %>%
  filter(order %in% 0:2) %>%
  ggplot() +
  geom_bar(aes(x = order, y = scaled, fill = order),
           stat = "identity")  +
  geom_text_repel(aes(x = order, y = 0.1, label = rows_label),
                  bg.color = "white", bg.r = 0.15,
                  point.size = NA,
                  xlim = c(-Inf, Inf),
                  ylim =  c(-Inf, Inf),
                  nudge_x = 0.1,
                  hjust = "left") +
  xlab("Step number") +
  ylab(NULL) +
  scale_fill_manual(values = viridis(n = 11, direction = -1)[3:1]) +
  scale_x_discrete(drop = F) +
  coord_flip() +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "none")
```

<br>

## Filter status

```{r echo = FALSE}
step_3_rows <- filter(step_data,
                      order == 3) %>%
  mutate(mil_row = n_rows / 1000000) %>%
  pull(mil_row) %>%
  round(digits = 2) %>%
  paste0(., " million")

step_3_dropped <- filter(step_data,
                         order == 3) %>%
  mutate(thou_row = number_dropped / 1000) %>%
  pull(thou_row) %>%
  round(digits = 2) %>%
  paste0(., " thousand")
```

We next filter the `ResultStatusIdentifier` column to include only the following sampling approval statuses:

-   `"Accepted"`
-   `"Final"`
-   `"Historical"`
-   `"Validated"`
-   `"Preliminary"`
-   `NA`

These statuses generally indicate that a sample's results are reliable, however we also include `NA` in an effort to be conservative. More specifically, when making decisions for this and other columns we retain `NA` values if removing those `NA` records would drop 10% or more of the available data (see ***Tiering, flagging, and quality control philosophy: Handling `NA` values*** for more details).

This step removes `r step_3_dropped` rows of data, resulting in `r step_3_rows` rows remaining.

```{r echo = FALSE}
step_data %>%
  filter(order %in% 0:3) %>%
  ggplot() +
  geom_bar(aes(x = order, y = scaled, fill = order),
           stat = "identity")  +
  geom_text_repel(aes(x = order, y = 0.1, label = rows_label),
                  bg.color = "white", bg.r = 0.15,
                  point.size = NA,
                  xlim = c(-Inf, Inf),
                  ylim =  c(-Inf, Inf),
                  nudge_x = 0.1,
                  hjust = "left") +
  xlab("Step number") +
  ylab(NULL) +
  scale_fill_manual(values = viridis(n = 11, direction = -1)[4:1]) +
  scale_x_discrete(drop = F) +
  coord_flip() +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "none")
```

<br>

## Filter media

```{r echo = FALSE}
step_4_rows <- filter(step_data,
                      order == 4) %>%
  mutate(mil_row = n_rows / 1000000) %>%
  pull(mil_row) %>%
  round(digits = 2) %>%
  paste0(., " million")

step_4_dropped <- filter(step_data,
                         order == 4) %>%
  mutate(thou_row = number_dropped / 1000) %>%
  pull(thou_row) %>%
  round(digits = 2) %>%
  paste0(., " thousand")
```

Next the `ActivityMediaSubdivisionName` is filtered to only include the following media types:

-   `"Surface Water"`
-   `"Water"`
-   `"Estuary"`
-   `NA`

As a result, `r step_4_dropped` rows are dropped and `r step_4_rows` remain.

```{r echo = FALSE}
step_data %>%
  filter(order %in% 0:4) %>%
  ggplot() +
  geom_bar(aes(x = order, y = scaled, fill = order),
           stat = "identity")  +
  geom_text_repel(aes(x = order, y = 0.1, label = rows_label),
                  bg.color = "white", bg.r = 0.15,
                  point.size = NA,
                  xlim = c(-Inf, Inf),
                  ylim =  c(-Inf, Inf),
                  nudge_x = 0.1,
                  hjust = "left") +
  xlab("Step number") +
  ylab(NULL) +
  scale_fill_manual(values = viridis(n = 11, direction = -1)[5:1]) +
  scale_x_discrete(drop = F) +
  coord_flip() +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "none")
```

<br>

## Location type

```{r echo = FALSE}
step_5_rows <- filter(step_data,
                      order == 5) %>%
  mutate(mil_row = n_rows / 1000000) %>%
  pull(mil_row) %>%
  round(digits = 2) %>%
  paste0(., " million")

step_5_dropped <- filter(step_data,
                         order == 5) %>%
  mutate(thou_row = number_dropped / 1000) %>%
  pull(thou_row) %>%
  round(digits = 2)
```

The final step in pre-harmonization is filtering out any `ResolvedMonitoringLocationTypeName` that is not `"Estuary"`, `"Lake, Reservoir, Impoundment"`, or `"Stream"`.

After dropping `r step_5_dropped` rows the pre-harmonization dataset is complete with `r step_5_rows`.

```{r echo = FALSE}
step_data %>%
  filter(order %in% 0:5) %>%
  ggplot() +
  geom_bar(aes(x = order, y = scaled, fill = order),
           stat = "identity")  +
  geom_text_repel(aes(x = order, y = 0.1, label = rows_label),
                  bg.color = "white", bg.r = 0.15,
                  point.size = NA,
                  xlim = c(-Inf, Inf),
                  ylim =  c(-Inf, Inf),
                  nudge_x = 0.1,
                  hjust = "left") +
  xlab("Step number") +
  ylab(NULL) +
  scale_fill_manual(values = viridis(n = 11, direction = -1)[6:1]) +
  scale_x_discrete(drop = F) +
  coord_flip() +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = "none")
```
