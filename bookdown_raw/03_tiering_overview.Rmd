---
output:
  github_document:
    html_preview: false
# params:
#   documented_drops: NA
always_allow_html: true
---

# Tiering, flagging, and quality control philosophy

The variety of data providers, parameters, and methods in the WQP inevitably results in a heterogeneous data set that requires rigorous quality control before analytical use. In this chapter, we detail the general tiering, flagging, and quality control philosophy we uphold across all parameter groups.

## Handling `NA` values

Columns related directly to the interoperability of data in the WQP, specifically field and lab methodology and depth-related columns, often contain many `NA`s in part due to inconsistent entry approaches across data providers that utilize the WQP. A highly restrictive filtering of the WQP that requires fully complete metadata would result in a very limited subset of data, in part, due to the prevalence of these `NA` values. Therefore, we are building this data set to resolve as many `NA`s as possible, but to also include `NA`s within an "inclusive" data tier if all columns of interest are not resolvable. Specifically, we retain `NA` values if removing those `NA` records would drop 10% or more of the available data.

## Heterogenous data

In addition to `NA` values, WQP entries can be heterogeneous for reasons such as:

-   Having a variety of analytical methods with different levels of precision and accuracy that are used to quantify the same parameter
-   Having a variety of sampling methods used to aquire the same parameter with varying levels of interoperability or necessary context to determine interoperability
-   Having a variety of names or descriptions that represent the same analytical or sampling method across different organizations
-   Having information relevant to assessing data reliability or method choice spread across multiple columns
-   Containing observations with sample collection methods and analytical methods that are incompatible
-   Having data with differing levels of metadata

In order to control for some of this variation and provide end-users with something more readily navigable we have incorporated several tiers and flagging systems into the AquaSat v2 dataset:

-   **Analytical method tiering**: Tiers indicating the interoperability of data based on the analytical method used to acquire measurements
-   **Field flags**: Flags indicating whether the sample collection method is consistent with the analytical method
-   **Depth flags**: Flags indicating the type of sampling water depth measurement or completeness of the sampling water depth measurement

### Analytical method tiering

The `ResultAnalyticalMethod.MethodName` column from the WQP is the primary column we use for determining which analytical method tier each record falls within. Details on how each parameter's methods were sorted into tiers can be found in its corresponding harmonization chapter.

The primary purpose of our analytical method tiering is to determine the reliability and accuracy of each analytical method across data providers and throughout time for each parameter in the AquaSat v2 data set. We developed the following categories, which are represented in the `analytical_tier` column of the final data set:

-   **Tier 0: Restrictive.** Data that are verifiably self-similar across organizations and time-periods and can be considered highly reliable and interoperable
-   **Tier 1: Narrowed.** Data that we have good reason to believe are self-similar, but for which we can't verify full interoperability
-   **Tier 2: Inclusive.** Data that are assumed to be reliable and are harmonized to our best ability given the information available from the data provider. This tier includes `NA` or non-resolvable descriptions for the analytical method, which often make up the majority of method descriptions for any given parameter. Because this tier represents many analytical methods, direct interoperability between samples is not guaranteed.

### Field flags

The `field_flag` column is used to check if the sample collection method (`SampleCollectionMethod.MethodName`) is reasonable (flag = 0), suspect (flag = 1), or inconclusive (flag = 2). "Reasonable" flags mean that the sample collection method and the analytical method or tier are in harmony with one another. "Suspect" flags are assigned when the sample collection method description isn't consistent with what would be expected given the `characteristicName` and the `ResultAnalyticalMethod.MethodName` for a given record. "Inconclusive" flags are automatically assigned to records contained in the "inclusive" analytical tier because this tier includes values such as `NA`, where it's typically impossible to determine the appropriateness of a collection method for the sample record. The relationship between field flags and analytical tiers will vary by parameter; thus, each harmonization chapter contains specific information for these different cases.

### Depth flags

There are four columns that explicitly contain depth information for a given WQP entry, all of which contain a variety of measurement units. Below is a list of the four columns and their definitions according to the [{dataRetrieval} package documentation](https://rconnect.usgs.gov/dataRetrieval/reference/readWQPqw.html).

1.  `ActivityDepthHeightMeasure.MeasureValue`: "A measurement of the vertical location (measured from a reference point) at which an activity occurred."
2.  `ResultDepthHeightMeasure.MeasureValue`: "A measurement of the vertical location (measured from a reference point) at which a result occurred." *Only in STORET*
3.  `ActivityTopDepthHeightMeasure.MeasureValue`: "A measurement of the upper vertical location of a vertical location range (measured from a reference point) at which an activity occurred."
4.  `ActivityBottomDepthHeightMeasure.MeasureValue`: "A measurement of the lower vertical location of a vertical location range (measured from a reference point) at which an activity occurred."

Each of the above columns has a corresponding column containing [the associated unit used in measuring the item](https://rconnect.usgs.gov/dataRetrieval/reference/readWQPqw.html):

1.  `ActivityDepthHeightMeasure.MeasureUnitCode`
2.  `ResultDepthHeightMeasure.MeasureUnitCode`
3.  `ActivityTopDepthHeightMeasure.MeasureUnitCode`
4.  `ActivityBottomDepthHeightMeasure.MeasureUnitCode`

#### Pre-processing

Prior to assigning the `depth_flag` we complete a few pre-processing steps:

1.  Convert the following values to an explicit `NA`: "NA", "999", "-999", "9999", "-9999", "-99", "99", "NaN"
2.  Convert depths in all four columns to meters from the depth unit listed by the data provider
3.  Create a single "discrete" sample depth column using a combination of the `ActivityDepthHeightMeasure.MeasureValue` and `ResultDepthHeightMeasure.MeasureValue` columns. We use `ActivityDepth` value when `ResultDepth` value is missing, and `ResultDepth` when `ActivityDepth` is missing. If both columns have values but disagree we use an average of the two.

This pre-processing results in three "harmonized" columns reporting sampling water depth values in meters: `harmonized_discrete_depth_value`, `harmonized_top_depth_value`, `harmonized_bottom_depth_value`.

Sample depth flags are assigned using the harmonized depth columns that result from the pre-processing steps above. If the record has no depth listed it is designated a `depth_flag` of 0. A record with only discrete depth (listed in the `harmonized_discrete_depth_value` is given a `depth_flag` of 1. A record with top and/or bottom depth (`harmonized_top_depth_value`, `harmonized_bottom_depth_value`), indicating an integrated sample, is assigned a `depth_flag` of 2, and any combination of discrete + top and/or bottom depths is assigned a `depth_flag` of 3, since the sample depth(s) can not be reconciled with certainty.

### General note

Generally speaking, we avoid further classification for any WQP entry's parameter methodology, tier, or flag unless there are at least 1% of observations with the same unresolved text.

## Simultaneous records

The WQP contains records that can be considered true duplicates and others where multiple non-identical measurements are recorded at the same time, place, and depth by the same organization. We deal with these within each parameter's harmonization step by taking the median value from simultaneous observations. For context on how these values were calculated, we report the total number of entries contributing to the median value reported as well as the standard deviation of the mean as additional columns in the dataset (`______` and `harmonized_value_sd`, repsectively).

This record aggregation is deal with separately for each parameter so that specific accommodations can be made based on their specific tiering and cleaning processes. Additionally, this step also requires us to group the data set by a subset of its original columns, necessarily resulting in a reduced subset of columns in the final data product. To aide in back-joining for advanced AquaSat users, we provide a `subgroup_id` column identifying the grouping used to create the aggregated median value. The `subgroup_id` is also present in the upstream, pre-aggregated dataset that contains all records prior to aggregation and the original WQP columns along with the columns created in the harmonization steps. The upstream, pre-aggregated dataset is the `p3_chla_preagg_grouped` pipeline target.
